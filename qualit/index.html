<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Di√°rio de Atendimento</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            margin: 5px;
            padding: 5px 10px;
        }
    </style>
    <script>
        const nichos    = [" ", "LOJA", "FARM√ÅCIA", "SUPERMERCADO"];
        const situacoes = [" ", "ATENDIMENTO", "PROSPEC√á√ÉO"];
        const canais    = [" ", "CHAT", "VOZ"];
        const status    = [" ", "CHAMADA N√ÉO ATENDIDA", "CAIXA POSTAL", "CONTATO INCORRETO", "ATENDIMENTO EFETUADO", "PEDIDO CONCLU√çDO", "CAT√ÅLOGO ENVIADO", "OUTROS"];

        function createSelect(options, selectedValue = "") {
            let select = document.createElement("select");
            options.forEach(option => {
                let opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                if (option === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
            return select;
        }

        function populateRow(row, data = {}) {
            row.dataset.id = data.id || ""; // Armazena o ID da linha

            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.nome || "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(nichos, data.nicho));
            row.appendChild(document.createElement("td")).appendChild(createSelect(situacoes, data.situacao));
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.data || "";
            row.lastChild.firstChild.type = "date";
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.hora || "";
            row.lastChild.firstChild.type = "time";
            row.appendChild(document.createElement("td")).appendChild(createSelect(canais, data.canal));
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.observacoes || "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(status, data.status));

            // Bot√£o Atualizar
            let updateBtn = document.createElement("button");
            updateBtn.textContent = "üíæ";
            updateBtn.onclick = () => ATUALIZAR(row);
            row.appendChild(document.createElement("td")).appendChild(updateBtn);

            // Bot√£o Excluir
            let deleteBtn = document.createElement("button");
            deleteBtn.textContent = "üóëÔ∏è";
            deleteBtn.onclick = () => EXCLUIR(row);
            row.lastChild.appendChild(deleteBtn);
        }

        function NOVO(data = {}) {
            let tbody = document.querySelector("tbody");
            let row = document.createElement("tr");
            populateRow(row, data);
            tbody.insertBefore(row, tbody.firstChild); // Insere a nova linha no topo
        }

        async function fetchData() {
            try {
                let response = await fetch("https://natalvalerio.pythonanywhere.com/api/select/qualit");
                let data = await response.json();
                let tbody = document.querySelector("tbody");
                tbody.innerHTML = ""; 
                data.forEach(item => NOVO(item));
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
            }
        }

        async function SALVAR() {
            let tbody = document.querySelector("tbody");
            let firstRow = tbody.rows[0]; // Captura a primeira linha
            let data = {};

            firstRow.querySelectorAll("td").forEach((td, index) => {
                if (index === 0) data.nome = td.querySelector("input").value;
                if (index === 1) data.nicho = td.querySelector("select").value;
                if (index === 2) data.situacao = td.querySelector("select").value;
                if (index === 3) data.data = td.querySelector("input").value;
                if (index === 4) data.hora = td.querySelector("input").value;
                if (index === 5) data.canal = td.querySelector("select").value;
                if (index === 6) data.observacoes = td.querySelector("input").value;
                if (index === 7) data.status = td.querySelector("select").value;
            });

            let sqlQuery = `insert into qualit (nome, nicho, situacao, data, hora, canal, observacoes, status) values ('${data.nome}', '${data.nicho}', '${data.situacao}', '${data.data}', '${data.hora}', '${data.canal}', '${data.observacoes}', '${data.status}')`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            try {
                let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    alert("Erro ao salvar dados!");
                    console.error("Erro:", response.status, response.statusText);
                } else {
                    alert("Dados salvos com sucesso!");
                    fetchData();
                }
            } catch (error) {
                alert("Erro ao salvar dados.");
                console.error("Erro ao salvar dados: ", error);
            }
        }

        async function ATUALIZAR(row) {
            let id = row.dataset.id;
            if (!id) {
                alert("N√£o √© poss√≠vel atualizar uma linha sem ID.");
                return;
            }

            let data = {};
            row.querySelectorAll("td").forEach((td, index) => {
                if (index === 0) data.nome = td.querySelector("input").value;
                if (index === 1) data.nicho = td.querySelector("select").value;
                if (index === 2) data.situacao = td.querySelector("select").value;
                if (index === 3) data.data = td.querySelector("input").value;
                if (index === 4) data.hora = td.querySelector("input").value;
                if (index === 5) data.canal = td.querySelector("select").value;
                if (index === 6) data.observacoes = td.querySelector("input").value;
                if (index === 7) data.status = td.querySelector("select").value;
            });

            let sqlQuery = `update qualit set nome='${data.nome}', nicho='${data.nicho}', situacao='${data.situacao}', data='${data.data}', hora='${data.hora}', canal='${data.canal}', observacoes='${data.observacoes}', status='${data.status}' where id=${id}`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            try {
                let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    alert("Erro ao atualizar dados!");
                    console.error("Erro:", response.status, response.statusText);
                } else {
                    alert("Dados atualizados com sucesso!");
                    fetchData();
                }
            } catch (error) {
                alert("Erro ao atualizar dados.");
                console.error("Erro ao atualizar dados: ", error);
            }
        }

        async function EXCLUIR(row) {
            let id = row.dataset.id;
            if (!id) {
                alert("N√£o √© poss√≠vel excluir uma linha sem ID.");
                return;
            }

            let sqlQuery = `delete from qualit where id=${id}`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            if (confirm("Tem certeza de que deseja excluir esta linha?")) {
                try {
                    let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });
                    if (!response.ok) {
                        alert("Erro ao excluir dados!");
                        console.error("Erro:", response.status, response.statusText);
                    } else {
                        alert("Dados exclu√≠dos com sucesso!");
                        fetchData();
                    }
                } catch (error) {
                    alert("Erro ao excluir dados.");
                    console.error("Erro ao excluir dados: ", error);
                }
            }
        }

        window.onload = fetchData;
    </script>
</head>
<body>
    <img src="imagem.png" width="200" alt="Logo da Empresa">
    <h2>Relat√≥rio Di√°rio de Atendimento</h2>
    <button onclick="NOVO()">NOVO ‚ûï</button>
    <button onclick="SALVAR()">SALVAR üíæ</button>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Nicho</th>
                <th>Situa√ß√£o</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Canal</th>
                <th>Observa√ß√µes</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</body>
</html>
