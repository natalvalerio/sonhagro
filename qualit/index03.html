<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Diário de Atendimento</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script>
        const nichos = [" ", "LOJA", "FARMÁCIA", "SUPERMERCADO"];
        const situacoes = [" ", "ATENDIMENTO", "PROSPECÇÃO"];
        const canais = [" ", "CHAT", "VOZ"];
        const status = [" ", "CHAMADA NÃO ATENDIDA", "CAIXA POSTAL", "CONTATO INCORRETO", "ATENDIMENTO EFETUADO", "PEDIDO CONCLUÍDO", "CATÁLOGO ENVIADO", "OUTROS"];

        function createSelect(options, selectedValue = "") {
            let select = document.createElement("select");
            options.forEach(option => {
                let opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                if (option === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
            return select;
        }

        function populateRow(row, data = {}) {
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.nome || "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(nichos, data.nicho));
            row.appendChild(document.createElement("td")).appendChild(createSelect(situacoes, data.situacao));
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.data || "";
            row.lastChild.firstChild.type = "date";
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.hora || "";
            row.lastChild.firstChild.type = "time";
            row.appendChild(document.createElement("td")).appendChild(createSelect(canais, data.canal));
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.observacoes || "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(status, data.status));
        }

		//--------------------------------------------------------------------------------------------
        function NOVO(data = {}) {
            let tbody = document.querySelector("tbody");
            let row = document.createElement("tr");
            populateRow(row, data);
            tbody.appendChild(row);
        }

		//--------------------------------------------------------------------------------------------
        async function fetchData() {
            try {
//                let response = await fetch("https://natalvalerio.pythonanywhere.com/api/select/qualit");
                let response = await fetch("https://natalvalerio.pythonanywhere.com/api/sql?sql=select * from qualit order by id desc");
                let data = await response.json();
                let tbody = document.querySelector("tbody");
                tbody.innerHTML = ""; 
                data.forEach(item => NOVO(item));
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
            }
        }

		//--------------------------------------------------------------------------------------------
		async function SALVAR() {
			let tbody = document.querySelector("tbody");
			let lastRow = tbody.rows[tbody.rows.length - 1];
			let data = {};
		
			lastRow.querySelectorAll("td").forEach((td, index) => {
				if (index === 0) data.nome = td.querySelector("input").value;
				if (index === 1) data.nicho = td.querySelector("select").value;
				if (index === 2) data.situacao = td.querySelector("select").value;
				if (index === 3) data.data = td.querySelector("input").value;
				if (index === 4) data.hora = td.querySelector("input").value;
				if (index === 5) data.canal = td.querySelector("select").value;
				if (index === 6) data.observacoes = td.querySelector("input").value;
				if (index === 7) data.status = td.querySelector("select").value;
			});
		
			let sqlQuery = `insert into qualit (nome, nicho, situacao, data, hora, canal, observacoes, status) values ('${data.nome}', '${data.nicho}', '${data.situacao}', '${data.data}', '${data.hora}', '${data.canal}', '${data.observacoes}', '${data.status}')`;
			// Codifica o SQL para evitar problemas com caracteres especiais
			let encodedQuery = encodeURIComponent(sqlQuery);
		
			alert(encodedQuery); // Verifique o SQL gerado
		
			try {
				let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
					method: "GET",
					headers: {
						"Content-Type": "application/json",
					},
			});
				
			// Verifique a resposta completa para entender o erro
			if (!response.ok) {
				alert("Erro 01:", response.status, response.statusText);
				console.error("Erro 01:", response.status, response.statusText);
			} else {
				alert("Dados Salvos!");
				console.log("Dados Salvos!");
				fetchData();
			}


			} catch (error) {
				alert("Erro 02 ao salvar dados: ", error)
				console.error("Erro ao salvar dados: ", error);
			}
		}


        window.onload = fetchData;
    </script>
</head>
<body>
    <img src="imagem.png" width="200" alt="Logo da Empresa">
    <h2>Relatório Diário de Atendimento</h2>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Nicho</th>
                <th>Situação</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Canal</th>
                <th>Observações</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <button onclick="NOVO()">NOVO</button>
    <button onclick="SALVAR()">SALVAR</button>
</body>
</html>
