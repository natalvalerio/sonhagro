<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="img/icon.png" rel="shortcut icon" type="image/x-icon" >
    <title>Relat√≥rio Di√°rio de Atendimento</title>
    <!--
	verde #4CAF50;
	amarelo #FFCC00;
	azul #393996;
	Amarelo claro: #FFE680 (uma vers√£o mais clara do #FFCC00).
	Azul claro: #A1A1D6 (uma vers√£o mais clara do #393996).
	-->
	<style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #A1A1D6;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1000;
        }

        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #FFE680;
            color: #393996;
            text-align: center;
            padding: 10px;
        }

        main {
            margin-top: 120px;
            margin-bottom: 60px;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th {
            background-color: #FFE680;
            color: #393996;
            position: sticky;
            top: 0;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        td input, td select {
            width: 100%;
            border: none;
            background-color: transparent;
            outline: none;
            font-size: 14px;
        }

        td input[type="date"], td input[type="time"] {
            width: auto;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        #Pesquisar {
            padding: 8px;
            font-size: 14px;
            width: 300px;
        }
		
		#Pesquisar::placeholder {
			color: rgba(0, 0, 0, 0.4); /* Cor preta com 10% de transpar√™ncia */
		}

        button {
            padding: 10px 15px;
            background-color: #A1A1D6;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #393996;
        }
    </style>
	

    <script>
		//require('dotenv').config()
		//const apiNome = process.env.API_NOME
		//alert(apiNome)
	
	    function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString();
            document.getElementById("dateTime").textContent = dateTimeString;
        }

        setInterval(updateDateTime, 1000);
		

		function Pesquisar() {
			const termo = document.getElementById("Pesquisar").value.toLowerCase();
			const linhas = document.querySelectorAll("tbody tr");
		
			linhas.forEach(linha => {
				const colunas = linha.querySelectorAll("td");
				let encontrou = false;
		
				colunas.forEach((coluna, index) => {
					if (index !== colunas.length - 1) { // Ignora a √∫ltima coluna (A√á√ïES)
						let texto = "";
		
						// Verifica se a coluna cont√©m um input ou select
						if (coluna.querySelector("input")) {
							texto = coluna.querySelector("input").value.toLowerCase();
						} else if (coluna.querySelector("select")) {
							texto = coluna.querySelector("select").value.toLowerCase();
						} else {
							texto = coluna.textContent.toLowerCase();
						}
		
						if (texto.includes(termo)) {
							encontrou = true;
						}
					}
				});
		
				if (encontrou) {
					linha.style.display = "";
				} else {
					linha.style.display = "none";
				}
			});
		}
		
        const nichos    = [" ", "LOJA", "FARM√ÅCIA", "SUPERMERCADO"];
        const situacoes = [" ", "ATENDIMENTO", "PROSPEC√á√ÉO"];
        const canais    = [" ", "CHAT", "VOZ"];
        const status    = [" ", "CHAMADA N√ÉO ATENDIDA", "CAIXA POSTAL", "CONTATO INCORRETO", "ATENDIMENTO EFETUADO", "PEDIDO CONCLU√çDO", "CAT√ÅLOGO ENVIADO", "OUTROS"];

        function createSelect(options, selectedValue = "") {
            let select = document.createElement("select");
            options.forEach(option => {
                let opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                if (option === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
            return select;
        }

        function populateRow(row, data = {}) {
            row.dataset.id = data.id || ""; // Armazena o ID da linha

            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.nome || "";
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.contato|| "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(nichos, data.nicho));
            row.appendChild(document.createElement("td")).appendChild(createSelect(situacoes, data.situacao));

            //row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.data || "";
            //row.lastChild.firstChild.type = "date";
            //row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.hora || "";
            //row.lastChild.firstChild.type = "time";
			
			let dateInput = document.createElement("input");
            dateInput.type = "date";
            dateInput.value = data.data || new Date().toISOString().split('T')[0];
            row.appendChild(document.createElement("td")).appendChild(dateInput);

            let timeInput = document.createElement("input");
            timeInput.type = "time";
            let now = new Date();
            timeInput.value = data.hora || now.toTimeString().slice(0, 5);
            row.appendChild(document.createElement("td")).appendChild(timeInput);
			
            row.appendChild(document.createElement("td")).appendChild(createSelect(canais, data.canal));
            row.appendChild(document.createElement("td")).appendChild(document.createElement("input")).value = data.observacoes || "";
            row.appendChild(document.createElement("td")).appendChild(createSelect(status, data.status));

            // Bot√£o Atualizar
            let updateBtn = document.createElement("button");
            updateBtn.textContent = "üíæ";
            updateBtn.onclick = () => ATUALIZAR(row);
            row.appendChild(document.createElement("td")).appendChild(updateBtn);

            // Bot√£o Excluir
            let deleteBtn = document.createElement("button");
            deleteBtn.textContent = "üóëÔ∏è";
            deleteBtn.onclick = () => EXCLUIR(row);
            row.lastChild.appendChild(deleteBtn);
        }

        function NOVO(data = {}) {
            let tbody = document.querySelector("tbody");
            let row = document.createElement("tr");
            populateRow(row, data);
            tbody.insertBefore(row, tbody.firstChild); // Insere a nova linha no topo
        }

        async function fetchData() {
            try {
                let response = await fetch("https://natalvalerio.pythonanywhere.com/api/select/qualit");
                let data = await response.json();
                let tbody = document.querySelector("tbody");
                tbody.innerHTML = ""; 
                data.forEach(item => NOVO(item));
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
            }
        }

        async function SALVAR() {
            let tbody = document.querySelector("tbody");
            let firstRow = tbody.rows[0]; // Captura a primeira linha
            let data = {};

            firstRow.querySelectorAll("td").forEach((td, index) => {
                if (index === 0) data.nome = td.querySelector("input").value;
                if (index === 1) data.contato = td.querySelector("input").value;
                if (index === 2) data.nicho = td.querySelector("select").value;
                if (index === 3) data.situacao = td.querySelector("select").value;
                if (index === 4) data.data = td.querySelector("input").value;
                if (index === 5) data.hora = td.querySelector("input").value;
                if (index === 6) data.canal = td.querySelector("select").value;
                if (index === 7) data.observacoes = td.querySelector("input").value;
                if (index === 8) data.status = td.querySelector("select").value;
            });

            let sqlQuery = `insert into qualit (nome, contato, nicho, situacao, data, hora, canal, observacoes, status) values ('${data.nome}', '${data.contato}', '${data.nicho}', '${data.situacao}', '${data.data}', '${data.hora}', '${data.canal}', '${data.observacoes}', '${data.status}')`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            try {
                let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    alert("Erro ao salvar dados!");
                    console.error("Erro:", response.status, response.statusText);
                } else {
                    alert("Dados salvos com sucesso!");
                    fetchData();
                }
            } catch (error) {
                alert("Erro ao salvar dados.");
                console.error("Erro ao salvar dados: ", error);
            }
        }

        async function ATUALIZAR(row) {
            let id = row.dataset.id;
            if (!id) {
                alert("N√£o √© poss√≠vel atualizar uma linha sem ID.");
                return;
            }

            let data = {};
            row.querySelectorAll("td").forEach((td, index) => {
                if (index === 0) data.nome = td.querySelector("input").value;
                if (index === 1) data.contato = td.querySelector("input").value;
                if (index === 2) data.nicho = td.querySelector("select").value;
                if (index === 3) data.situacao = td.querySelector("select").value;
                if (index === 4) data.data = td.querySelector("input").value;
                if (index === 5) data.hora = td.querySelector("input").value;
                if (index === 6) data.canal = td.querySelector("select").value;
                if (index === 7) data.observacoes = td.querySelector("input").value;
                if (index === 8) data.status = td.querySelector("select").value;
            });

            let sqlQuery = `update qualit set nome='${data.nome}', contato='${data.contato}', nicho='${data.nicho}', situacao='${data.situacao}', data='${data.data}', hora='${data.hora}', canal='${data.canal}', observacoes='${data.observacoes}', status='${data.status}' where id=${id}`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            try {
                let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {
                    alert("Erro ao atualizar dados!");
                    console.error("Erro:", response.status, response.statusText);
                } else {
                    alert("Dados atualizados com sucesso!");
                    fetchData();
                }
            } catch (error) {
                alert("Erro ao atualizar dados.");
                console.error("Erro ao atualizar dados: ", error);
            }
        }

        async function EXCLUIR(row) {
            let id = row.dataset.id;
            if (!id) {
                alert("N√£o √© poss√≠vel excluir uma linha sem ID.");
                return;
            }

            let sqlQuery = `delete from qualit where id=${id}`;
            let encodedQuery = encodeURIComponent(sqlQuery);

            if (confirm("Tem certeza de que deseja excluir esta linha?")) {
                try {
                    let response = await fetch(`https://natalvalerio.pythonanywhere.com/api/sql?sql=${encodedQuery}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });
                    if (!response.ok) {
                        alert("Erro ao excluir dados!");
                        console.error("Erro:", response.status, response.statusText);
                    } else {
                        alert("Dados exclu√≠dos com sucesso!");
                        fetchData();
                    }
                } catch (error) {
                    alert("Erro ao excluir dados.");
                    console.error("Erro ao excluir dados: ", error);
                }
            }
        }

        window.onload = fetchData;
    </script>
</head>
<body>
    <header>
		<img src="img/logo.png" width="200" alt="Logo da Empresa">
		<h2>Relat√≥rio Di√°rio de Atendimento</h2>
        <!--h1>Gerenciamento de Tabela</h1-->
    </header>

    <footer>
        <span id="dateTime"></span>
    </footer>
	<main>
	<BR/>
    <input type="text" id="Pesquisar" placeholder="üîé Pesquisar..."  onkeyup="Pesquisar()"> <!--onblur onkeyup-->
    <!--button onclick="addRow()">NOVO</button-->
    <button onclick="NOVO()">NOVO ‚ûï</button>
    <button onclick="SALVAR()">SALVAR üíæ</button>
    <table>
        <thead>
            <tr>
                <th>NOME</th>
                <th>CONTATO</th>
                <th>NICHO</th>
                <th>SITUA√á√ÉO</th>
                <th>DATA</th>
                <th>HORA</th>
                <th>CANAL</th>
                <th>OBSERVA√á√ïES</th>
                <th>STATUS</th>
                <th>A√á√ïES</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
	</main>
</body>
</html>
